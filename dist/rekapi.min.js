/*jslint browser: true, nomen: true, plusplus: true, undef: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.9.9 (Fri, 22 Jun 2012 02:21:16 GMT)
 * https://github.com/jeremyckahn/rekapi
 *
 * By Jeremy Kahn (jeremyckahn@gmail.com), with significant contributions from
 *   Franck Lecollinet
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore),
 *   Shifty.js (https://github.com/jeremyckahn/shifty).
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(a){function b(a,b,c,d){c.each(a._events[b],function(b){b(a,d)})}function c(a){var b=[];_.each(a._actors,function(a){b.push(a.getEnd())}),a._animationLength=Math.max.apply(Math,b)}function d(){}var e=function(a,d,e){function h(a,b){var c=Math.floor(b/a._animationLength);return c}function i(a){return s()-a._loopTimestamp}function j(a,b){return b>=a._timesToIterate&&a._timesToIterate!==-1}function k(a,c){j(a,c)&&(a.stop(),b(a,"animationComplete",d))}function l(a,b,c){var d;return j(a,c)?d=a._animationLength:d=b%a._animationLength,d}function m(a,b){var c=h(a,b),d=l(a,b,c);a.update(d),k(a,c)}function n(a){m(a,i(a))}function o(a){var b=function(){o(a),n(a)};a._scheduleUpdate.call?a._loopId=a._scheduleUpdate.call(g,b,1e3/a.config.fps):a._loopId=setTimeout(b,1e3/a.config.fps)}function p(a){var b;return a!==60?b=g.setTimeout:b=g.requestAnimationFrame||g.webkitRequestAnimationFrame||g.oRequestAnimationFrame||g.msRequestAnimationFrame||g.mozCancelRequestAnimationFrame&&g.mozRequestAnimationFrame||g.setTimeout,b}function q(a){var b;return a!==60?b=g.clearTimeout:b=g.cancelAnimationFrame||g.webkitCancelAnimationFrame||g.oCancelAnimationFrame||g.msCancelAnimationFrame||g.mozCancelRequestAnimationFrame||g.clearTimeout,b}function r(a){a._cancelUpdate.call?a._cancelUpdate.call(g,a._loopId):clearTimeout(a._loopId)}"use strict";var f=Function,g=f("return this")(),s=e.util.now,t={fps:60},u={STOPPED:"stopped",PAUSED:"paused",PLAYING:"playing"},v=a.Kapi||function(b){return this.config=b||{},this.context=this.config.context||{},this._actors={},this._playState=u.STOPPED,this._events={animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeUpdate:[],afterUpdate:[],addActor:[],removeActor:[]},this._timesToIterate=-1,this._animationLength=0,this._loopId=null,this._loopTimestamp=null,this._pausedAtTime=null,this._lastUpdatedMillisecond=0,d.extend(this.config,b),d.defaults(this.config,t),this._scheduleUpdate=p(this.config.fps),this._cancelUpdate=q(this.config.fps),d.each(this._contextInitHook,function(a){a.call(this)},this),this};v.prototype._contextInitHook={},v.prototype.addActor=function(a){return d.contains(this._actors,a)||(a.context()||a.context(this.context),a.kapi=this,a.fps=this.framerate(),this._actors[a.id]=a,c(this),a.setup(),b(this,"addActor",d,a)),this},v.prototype.getActor=function(a){return this._actors[a]},v.prototype.getActorIds=function(){return d.pluck(this._actors,"id")},v.prototype.getAllActors=function(){return d.clone(this._actors)},v.prototype.removeActor=function(a){return delete this._actors[a.id],delete a.kapi,a.teardown(),c(this),b(this,"removeActor",d,a),this},v.prototype.play=function(a){return r(this),this._playState===u.PAUSED?this._loopTimestamp+=s()-this._pausedAtTime:this._loopTimestamp=s(),this._timesToIterate=a||-1,this._playState=u.PLAYING,o(this),d.each(this._actors,function(a){a._state.isPaused&&a.resume()}),b(this,"playStateChange",d),b(this,"play",d),this},v.prototype.playFrom=function(a,b){return this.play(b),this._loopTimestamp=s()-a,this},v.prototype.playFromCurrent=function(a){return this.playFrom(this._lastUpdatedMillisecond,a)},v.prototype.pause=function(){return this._playState===u.PAUSED?this:(this._playState=u.PAUSED,r(this),this._pausedAtTime=s(),d.each(this._actors,function(a){a._state.isTweening&&a.pause()}),b(this,"playStateChange",d),b(this,"pause",d),this)},v.prototype.stop=function(){return this._playState=u.STOPPED,r(this),d.each(this._actors,function(a){a.stop()}),b(this,"playStateChange",d),b(this,"stop",d),this},v.prototype.isPlaying=function(){return this._playState===u.PLAYING},v.prototype.animationLength=function(){return this._animationLength},v.prototype.lastPositionUpdated=function(){return this._lastUpdatedMillisecond/this._animationLength},v.prototype.actorCount=function(){return d.size(this._actors)},v.prototype.framerate=function(a){return a&&(this.config.fps=a,this._scheduleUpdate=p(this.config.fps),this._cancelUpdate=q(this.config.fps)),this.config.fps},v.prototype.update=function(a){return b(this,"beforeUpdate",d),d.each(this._actors,function(b){b.updateState(a),typeof b.update=="function"&&b.update(b.context(),b.get())}),this._lastUpdatedMillisecond=a,b(this,"afterUpdate",d),this},v.prototype.on=function(a,b){if(!this._events[a])return;return this._events[a].push(b),this},v.prototype.off=function(a,b){if(!this._events[a])return;return b?this._events[a]=d.without(this._events[a],b):this._events[a]=[],this},v.prototype.exportTimeline=function(){var a={duration:this._animationLength,actors:{}};return d.each(this._actors,function(b){a.actors[b.id]=b.exportTimeline()},this),a},v.util={},typeof KAPI_DEBUG!="undefined"&&KAPI_DEBUG===!0&&(v._private={calculateLoopPosition:l,updateToCurrentMillisecond:n,tick:o,determineCurrentLoopIteration:h,calculateTimeSinceStart:i,isAnimationComplete:j,updatePlayState:k}),a.Kapi=v},f=function(a,b,e){function h(a){return a.sort(function(a,b){return a-b})}function i(a,b){var c=a._timelinePropertyCacheIndex,d=c.length,e;for(e=1;e<d;e++)if(c[e]>=b)return e-1;return-1}function j(a){b.each(a._propertyTracks,function(c,d){a._propertyTracks[d]=b.sortBy(a._propertyTracks[d],function(a){return a.millisecond})})}function k(a){b.each(a._timelinePropertyCaches,function(c,d){var e=l(a,+d);b.defaults(c,e)})}function l(a,c){var d={};return b.each(a._propertyTracks,function(a,e){var f=null;b.find(a,function(a){return a.millisecond>c?d[e]=f:a.millisecond===c&&(d[e]=a),f=a,!!d[e]});if(!d[e]){var g=b.last(a);g&&g.millisecond<=c&&(d[e]=g)}}),d}function m(a){b.each(a._propertyTracks,function(a,c){b.each(a,function(b,c){b.linkToNext(a[c+1])})})}function n(a,c,d){return b.find(a._propertyTracks[c],function(a){return a.millisecond===d})}function o(a){a._timelinePropertyCaches={},b.each(a._keyframeProperties,function(b){a._timelinePropertyCaches[b.millisecond]||(a._timelinePropertyCaches[b.millisecond]={}),a._timelinePropertyCaches[b.millisecond][b.name]=b},a),a._timelinePropertyCacheIndex=b.keys(a._timelinePropertyCaches),b.each(a._timelinePropertyCacheIndex,function(b,c){a._timelinePropertyCacheIndex[c]=+b},a),h(a._timelinePropertyCacheIndex),k(a),m(a)}"use strict";var f="linear",g=a.Kapi,p=g.Actor=function(a){return a=a||{},e.call(this),b.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:b.uniqueId(),setup:a.setup||d,update:a.update||d,teardown:a.teardown||d}),a.context&&this.context(a.context),this},q=function(){};q.prototype=e.prototype,p.prototype=new q,p.prototype.context=function(a){return a&&(this._context=a),this._context},p.prototype.keyframe=function(d,e,h){var i;return h=h||f,typeof h=="string"&&(i=h,h={},b.each(e,function(a,b){h[b]=i})),b.each(e,function(a,b){h[b]=h[b]||f}),b.each(e,function(a,b){var c=new g.KeyframeProperty(this,d,b,a,h[b]);this._keyframeProperties[c.id]=c,this._propertyTracks[b]||(this._propertyTracks[b]=[]),this._propertyTracks[b].push(c),j(this)},this),this.kapi&&c(this.kapi),o(this),this},p.prototype.getKeyframeProperty=function(a,b){if(this._propertyTracks[a]&&this._propertyTracks[a][b])return this._propertyTracks[a][b]},p.prototype.modifyKeyframeProperty=function(a,b,d){return this._propertyTracks[a]&&this._propertyTracks[a][b]&&this._propertyTracks[a][b].modifyWith(d),j(this),o(this),c(this.kapi),this},p.prototype.getTrackNames=function(){return b.keys(this._propertyTracks)},p.prototype.getTrackLength=function(a){if(!this._propertyTracks[a])return;return this._propertyTracks[a].length},p.prototype.copyProperties=function(a,c){var d={},e={};return b.each(this._propertyTracks,function(a,b){var f=n(this,b,c);f&&(d[b]=f.value,e[b]=f.easing)},this),this.keyframe(a,d,e),this},p.prototype.wait=function(a){var c=this.getEnd();if(a<=c)return this;var d=this.getEnd(),e=l(this,this.getEnd()),f={},g={};return b.each(e,function(a,b){f[b]=a.value,g[b]=a.easing}),this.removeKeyframe(d),this.keyframe(d,f,g),this.keyframe(a,f,g),this},p.prototype.getStart=function(){var a=[];return b.each(this._propertyTracks,function(b){b.length&&a.push(b[0].millisecond)}),a.length===0&&(a=[0]),Math.min.apply(Math,a)},p.prototype.getEnd=function(){var a=0;return b.each(this._propertyTracks,function(c){if(c.length){var d=b.last(c).millisecond;d>a&&(a=d)}},this),a},p.prototype.getLength=function(){return this.getEnd()-this.getStart()},p.prototype.hasKeyframeAt=function(a,c){var d=this._propertyTracks;if(c){if(!b.has(d,c))return!1;d=b.pick(d,c)}return b.find(d,function(b,c){return n(this,c,a)!==undefined},this)!==undefined},p.prototype.modifyKeyframe=function(a,c,d){return d=d||{},b.each(this._propertyTracks,function(b,e){var f=n(this,e,a);f&&f.modifyWith({value:c[e],easing:d[e]})},this),this},p.prototype.removeKeyframe=function(a){return b.each(this._propertyTracks,function(c,d){var e=-1,f=!1;b.find(c,function(b){return e++,f=a===b.millisecond,f});if(f){var g=c.splice(e,1)[0];g&&delete this._keyframeProperties[g.id]}},this),this.kapi&&c(this.kapi),o(this),this},p.prototype.removeAllKeyframeProperties=function(){return b.each(this._propertyTracks,function(a,b){a.length=0},this),this._keyframeProperties={},this.removeKeyframe(0)},p.prototype.updateState=function(a){var c=this.getStart(),d=this.getEnd();if(c<=a&&a<=d){var e=i(this,a),f=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[e]],g={};b.each(f,function(b,c){b&&(g[c]=b.getValueAt(a))}),this.set(g)}return this},p.prototype.data=function(a){return a&&(this._data=a),this._data},p.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};return b.each(this._propertyTracks,function(c,d){var e=a.propertyTracks[d]=[];b.each(c,function(a){e.push(a.exportPropertyData())})}),a}},g=function(a,b,c){"use strict";var d="linear",e=a.Kapi,f=e.KeyframeProperty=function(a,c,e,f,g){return this.id=b.uniqueId("keyframeProperty_"),this.ownerActor=a,this.millisecond=c,this.name=e,this.value=f,this.easing=g||d,this.nextProperty=null,this};f.prototype.modifyWith=function(a){var c={};b.each(["millisecond","easing","value"],function(b){c[b]=typeof a[b]=="undefined"?this[b]:a[b]},this),b.extend(this,c)},f.prototype.linkToNext=function(a){this.nextProperty=a||null},f.prototype.getValueAt=function(a){var b={},d={},e;if(this.nextProperty){b[this.name]=this.value,d[this.name]=this.nextProperty.value;var f=this.nextProperty.millisecond-this.millisecond,g=(a-this.millisecond)/f;e=c.util.interpolate(b,d,g,this.nextProperty.easing)[this.name]}else e=this.value;return e},f.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},h=function(a,c){function e(a,b,c){return typeof c!="undefined"&&(a[b]=c,a.style[b]=c+"px"),a[b]}function f(a){a.config.clearOnUpdate&&a.canvasClear()}function g(a){b(a,"beforeDraw",c);var d=a._drawOrder.length,e;if(a._drawOrderSorter){var f=c.sortBy(a._canvasActors,a._drawOrderSorter);e=c.pluck(f,"id")}else e=a._drawOrder;var g,h,i;for(i=0;i<d;i++)g=a._canvasActors[e[i]],h=g.context(),g.draw(h,g.get());return b(a,"afterDraw",c),a}function h(a,b){b instanceof d.CanvasActor&&(a._drawOrder.push(b.id),a._canvasActors[b.id]=b)}function i(a,b){b instanceof d.CanvasActor&&(a._drawOrder=c.without(a._drawOrder,b.id),delete a._canvasActors[b.id])}"use strict";var d=a.Kapi;d.prototype._contextInitHook.canvas=function(){this._drawOrder=[],this._drawOrderSorter=null,this._canvasActors={},this.config.clearOnUpdate=!0,c.extend(this._events,{beforeDraw:[],afterDraw:[]}),c.each(["Height","Width"],function(a){var b=a.toLowerCase();this.config[b]&&(this["canvas"+a](this.config[b]),delete this.config[a])},this),this.on("afterUpdate",g),this.on("addActor",h),this.on("removeActor",i),this.on("beforeDraw",f)},d.prototype.canvasHeight=function(a){return e(this.context,"height",a)},d.prototype.canvasWidth=function(a){return e(this.context,"width",a)},d.prototype.canvasClear=function(){return this.context.getContext&&this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight()),this},d.prototype.canvasContext=function(){return this.context.getContext("2d")},d.prototype.redraw=function(){return g(this),this},d.prototype.moveActorToLayer=function(a,b){if(b<this._drawOrder.length)return this._drawOrder=c.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a;return},d.prototype.setOrderFunction=function(a){return this._drawOrderSorter=a,this},d.prototype.unsetOrderFunction=function(){return this._drawOrderSorter=null,this},d.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};return c.each(this._drawOrder,function(b){a.actors[b]=this._actors[b].exportTimeline()},this),a}},i=function(a,b){function e(){}"use strict";var c=a.Kapi;e.prototype=c.Actor.prototype;var f=c.CanvasActor=function(a){return c.Actor.call(this,a),a=a||{},this.draw=a.draw||d,this};f.prototype=new e,f.prototype.context=function(a){return a&&(this._context=a),this._context&&this._context.getContext("2d")},f.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)}},j=function(a,b){function f(a,b,c){a.style[b]=c}function g(a){return b.contains(e,a)}function h(a,c){var d=[];return b.each(a,function(a){c[a]&&d.push(a+"("+c[a]+")")}),d.join(" ")}function i(a,c){b.each(d,function(b){f(a,b,c)})}function j(){}"use strict";var c=a.Kapi,d=["transform","webkitTransform","MozTransform","oTransform","msTransform"],e=["translateX","translateY","scale","scaleX","scaleY","rotate","skewX","skewY"];c.DOMActor=function(a){c.Actor.call(this),this._context=a;var b=this.getCSSName();return this._context.className.match(b)||(this._context.className+=" "+b),this._transformOrder=e.slice(0),delete this.update,delete this.teardown,this},j.prototype=c.Actor.prototype,c.DOMActor.prototype=new j,j.prototype.update=function(a,c){var d=b.keys(c),e=b.filter(d,g),j=b.reject(d,g),k=b.pick(c,j);if(e.length){var l=b.pick(c,e),m=h(this._transformOrder,l);i(a,m)}else c.transform&&i(a,c.transform);b.each(k,function(b,c){f(a,c,b)},this)},j.prototype.teardown=function(a,c){var d=this._context.className.match(/\S+/g),e=b.without(d,this.getCSSName());this._context.className=e},j.prototype.getCSSName=function(){return"actor-"+this.id},j.prototype.setTransformOrder=function(a){var c=b.reject(a,g);if(c.length)throw"Unknown or unsupported transform functions: "+c.join(", ");return this._transformOrder=b.uniq(a),this}},k=function(a,b){function i(a){return/rgb/.test(a)}function j(a){var c=["{"],d;return b.each(a.get(),function(a,b){d=a;var f=b;b==="transform"&&(f=e),c.push(f+":"+d+";")}),c.push("}"),c.join("")}function k(a,b){var c=a.getLength(),d=a.getStart(),e=[],f,g,h,i=c/b,k=Math.floor(i),l=c/100,m=d+i,n=c+d-i;a.updateState(d),e.push("  from "+j(a));var o;for(o=m;o<=n;o+=i)a.updateState(o),f=(o-d)/l,g=+f.toFixed(2),h=g+"% ",e.push("  "+h+j(a));return a.updateState(c+d),e.push("  to "+j(a)),e.join("\n")}function l(a,c,d){d=d||["w3"];var e=[];return b.each(d,function(b){var d=p(g,[f[b],c,a]),h=m(d,b);e.push(h)}),e.join("\n")}function m(a,b){var c=new RegExp(e,"g"),d=f[b]+"transform",g=a.replace(c,d);return g}function n(a,c,d){c=c||["w3"];var e=[],f;b.each(c,function(b){f=o(a,b,d),e.push(f)});var g=p(h,[d,e.join("\n")]);return g}function o(a,b,c){var d=[],e=f[b],g=a.getStart(),h=a.getEnd()-g;h=p("  %sanimation-duration: %sms;",[e,h]),d.push(h);var i=p("  %sanimation-name: %s;",[e,c+"-keyframes"]);d.push(i);var j=p("  %sanimation-delay: %sms;",[e,g]);d.push(j);var k=p("  %sanimation-fill-mode: forwards;",[e]);return d.push(k),d.join("\n")}"use strict";var c=a.Kapi,d=100,e="TRANSFORM",f=c.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},g=["@%skeyframes %s-keyframes {","%s","}"].join("\n"),h=[".%s {","  position: absolute;","%s","}"].join("\n");a.Kapi.prototype.toCSS=function(a){a=a||{};var c=[],d=this.getActorIds();return b.each(d,function(b){c.push(this.getActor(b).toCSS(a))},this),c.join("\n")},a.Kapi.Actor.prototype.toCSS=function(a){a=a||{};var b=[],c=a.name||this.getCSSName(),e=a.granularity||d,f=n(this,a.vendors,c);b.push(f);var g=k(this,e),h=l(g,c,a.vendors);return b.push(h),b.join("\n")};var p=c.util.printf=function(a,c){var d=a;return b.each(c,function(a){d=d.replace("%s",a)}),d}},l=function(a,b){"use strict";var c=b?{}:a,d=b&&b.underscore?b.underscore:c._,l=b&&b.Tweenable?b.Tweenable:c.Tweenable;return e(c,d,l),f(c,d,l),g(c,d,l),typeof j=="function"&&j(c,d,l),typeof k=="function"&&k(c,d,l),typeof h=="function"&&h(c,d,l),typeof i=="function"&&i(c,d,l),c.Kapi};if(typeof define=="function"&&define.amd){var m=typeof _!="undefined";define(["shifty","underscore"],function(b,c){var d=c!==null,e={Tweenable:b,underscore:d?c:_},f=l(a,e);return typeof KAPI_DEBUG!="undefined"&&KAPI_DEBUG===!0&&(f.underscore_version=e.underscore.VERSION),!m&&d&&(a._=undefined),f})}else l(typeof a!="undefined"?a:this)})(this)