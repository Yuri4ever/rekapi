/**
 * Rekapi - Rewritten Kapi. v0.8.7
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var z=function(g,a,c){function i(d){return d.sort(function(d,b){return d-b})}function j(d,b){return Math.floor(b/d._animationLength)}function l(d){return n()-d._loopTimestamp}function o(d,b){return b>=d._timesToIterate&&-1!==d._timesToIterate}function k(d,b){o(d,b)&&(d.stop(),h(d,"onAnimationComplete"))}function f(d,b,e){return o(d,e)?d._animationLength:b%d._animationLength}function p(d){var b=l(d),e;e=j(d,b);b=f(d,b,e);d.render(b);k(d,e)}function m(d){var b=function(){m(d);p(d)};d._loopId=
d._scheduleUpdate.call?d._scheduleUpdate.call(c,b,1E3/d.config.fps):setTimeout(b,1E3/d.config.fps)}function h(d,b){e.each(d._events[b],function(b){b(d)})}function s(d){return 60!==d?c.setTimeout:c.requestAnimationFrame||c.webkitRequestAnimationFrame||c.oRequestAnimationFrame||c.msRequestAnimationFrame||c.mozCancelRequestAnimationFrame&&c.mozRequestAnimationFrame||c.setTimeout}function b(d){return 60!==d?c.clearTimeout:c.cancelAnimationFrame||c.webkitCancelAnimationFrame||c.oCancelAnimationFrame||
c.msCancelAnimationFrame||c.mozCancelRequestAnimationFrame||c.clearTimeout}function q(d){d._cancelUpdate.call?d._cancelUpdate.call(c,d._loopId):clearTimeout(d._loopId)}var e=a&&a.underscore?a.underscore:g._,n=(a&&a.Tweenable?a.Tweenable:g.Tweenable).util.now,y={fps:60,clearOnUpdate:!0},a=g.Kapi||function(d){this.config=d||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],
onPlayStateChange:[],onPlay:[],onPause:[],onStop:[],onBeforeDraw:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;e.extend(this.config,d);e.defaults(this.config,y);this._scheduleUpdate=s(this.config.fps);this._cancelUpdate=b(this.config.fps);e.each(this._contextInitHook,function(d){d.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var d=[];e.each(this._actors,
function(b){d.push(b.getEnd())});this._animationLength=Math.max.apply(Math,d);return this};a.prototype.addActor=function(d){if(!e.contains(this._actors,d))d.context()||d.context(this.context),d.kapi=this,d.fps=this.framerate(),this._actors[d.id]=d,this._drawOrder.push(d.id),d.setup();return this};a.prototype.getActor=function(d){return this._actors[d]};a.prototype.getActorIds=function(){return e.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return e.clone(this._actors)};a.prototype.removeActor=
function(d){delete this._actors[d.id];delete d.kapi;this._drawOrder=e.without(this._drawOrder,d.id);d.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(d){q(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(n()-this._pausedAtTime):n();this._timesToIterate=d||-1;this._playState="playing";m(this);e.each(this._actors,function(d){d._state.isPaused&&d.resume()});h(this,"onPlayStateChange");h(this,"onPlay");return this};a.prototype.playFrom=function(d,
b){this.play(b);this._loopTimestamp=n()-d;return this};a.prototype.playFromCurrent=function(d){return this.playFrom(this._lastRenderedMillisecond,d)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";q(this);this._pausedAtTime=n();e.each(this._actors,function(d){d._state.isTweening&&d.pause()});h(this,"onPlayStateChange");h(this,"onPause");return this};a.prototype.stop=function(){this._playState="stopped";q(this);e.each(this._actors,function(d){d.stop()});
h(this,"onPlayStateChange");h(this,"onStop");return this};a.prototype.isPlaying=function(){return"playing"===this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(d){if(d)this.config.fps=d,this._scheduleUpdate=s(this.config.fps),this._cancelUpdate=b(this.config.fps);return this.config.fps};
a.prototype.render=function(d){this.calculateActorPositions(d);var b,q,a,n,c;h(this,"onBeforeDraw");q=this._drawOrder.length;this._drawOrderSorter?(b=e.sortBy(this._actors,this._drawOrderSorter),c=e.pluck(b,"id")):c=this._drawOrder;for(b=0;b<q;b++)a=this._actors[c[b]],n=a.context(),a.render(n,a.get());this._lastRenderedMillisecond=d;h(this,"onFrameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(d){for(var b=
this._drawOrder.length,e=0;e<b;e++)this._actors[this._drawOrder[e]].calculatePosition(d);return this};a.prototype.moveActorToLayer=function(d,b){if(b<this._drawOrder.length)return this._drawOrder=e.without(this._drawOrder,d.id),this._drawOrder.splice(b,0,d.id),d};a.prototype.bind=function(d,b){if(this._events[d])return this._events[d].push(b),this};a.prototype.unbind=function(d,b){if(this._events[d])return this._events[d]=b?e.without(this._events[d],b):[],this};a.prototype.setOrderFunction=function(d){this._drawOrderSorter=
d;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};a.prototype.exportTimeline=function(){var d={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};e.each(this._drawOrder,function(b){d.actors[b]=this._actors[b].exportTimeline()},this);return d};a.util={};e.extend(a.util,{noop:function(){},sortNumerically:i,calculateLoopPosition:f,calculateTimeSinceStart:l});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={sortNumerically:i,
calculateLoopPosition:f,renderCurrentMillisecond:p,tick:m,determineCurrentLoopIteration:j,calculateTimeSinceStart:l,isAnimationComplete:o,updatePlayState:k};g.Kapi=a},A=function(g,a){function c(b,a){for(var e=b._timelinePropertyCacheIndex,n=e.length,c=1;c<n;c++)if(e[c]>=a)return c-1;return-1}function i(b){h.each(b._propertyTracks,function(a,e){b._propertyTracks[e]=h.sortBy(b._propertyTracks[e],function(b){return b.millisecond})})}function j(b){h.each(b._timelinePropertyCaches,function(a,e){var c=
l(b,+e);h.defaults(a,c)})}function l(b,a){var e={};h.each(b._propertyTracks,function(b,c){var d=null;h.find(b,function(b){b.millisecond>a?e[c]=d:b.millisecond===a&&(e[c]=b);d=b;return!!e[c]});if(!e[c]){var f=h.last(b);f&&f.millisecond<=a&&(e[c]=f)}});return e}function o(b){h.each(b._propertyTracks,function(b){h.each(b,function(e,a){e.linkToNext(b[a+1])})})}function k(b,a,e){return h.find(b._propertyTracks[a],function(b){return b.millisecond===e})}var f,p,m,h=a&&a.underscore?a.underscore:g._,s=a&&
a.Tweenable?a.Tweenable:g.Tweenable;f=g.Kapi;p=0;f.Actor=function(b){b=b||{};this.constructor.call(this);h.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isPersisting:!1,id:p++,setup:b.setup||f.util.noop,render:b.render||f.util.noop,teardown:b.teardown||f.util.noop});b.context&&this.context(opt_context);return this};m=function(){};m.prototype=s.prototype;f.Actor.prototype=new m;f.Actor.prototype.context=function(b){if(b)this._context=
b;return this._context};f.Actor.prototype.keyframe=function(b,a,e){var c,e=e||"linear";"string"===typeof e&&(c=e,e={},h.each(a,function(b,d){e[d]=c}));h.each(a,function(b,d){e[d]=e[d]||"linear"});h.each(a,function(a,d){var c;c=new f.KeyframeProperty(this,b,d,a,e[d]);this._keyframeProperties[c.id]=c;this._propertyTracks[d]||(this._propertyTracks[d]=[]);this._propertyTracks[d].push(c);i(this)},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};f.Actor.prototype.getKeyframeProperty=
function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};f.Actor.prototype.modifyKeyframeProperty=function(b,a,e){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(e);i(this);this.invalidatePropertyCache();return this};f.Actor.prototype.getTrackNames=function(){return h.keys(this._propertyTracks)};f.Actor.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};
f.Actor.prototype.copyProperties=function(b,a){var e,c;e={};c={};h.each(this._propertyTracks,function(b,d){var f;if(f=k(this,d,a))e[d]=f.value,c[d]=f.easing},this);this.keyframe(b,e,c);return this};f.Actor.prototype.wait=function(b){var a=this.getEnd();if(b<=a)return this;var a=this.getEnd(),e=l(this,this.getEnd()),c={},f={};h.each(e,function(b,a){c[a]=b.value;f[a]=b.easing});this.removeKeyframe(a);this.keyframe(a,c,f);this.keyframe(b,c,f);return this};f.Actor.prototype.getStart=function(){var b=
[];h.each(this._propertyTracks,function(a){a.length&&b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};f.Actor.prototype.getEnd=function(){var b=0;h.each(this._propertyTracks,function(a){if(a.length)a=h.last(a).millisecond,a>b&&(b=a)},this);return b};f.Actor.prototype.getLength=function(){return this.getEnd()-this.getStart()};f.Actor.prototype.modifyKeyframe=function(b,a,e){e=e||{};h.each(this._propertyTracks,function(c,f){var d=k(this,f,b);d&&d.modifyWith({value:a[f],
easing:e[f]})},this);return this};f.Actor.prototype.removeKeyframe=function(b){h.each(this._propertyTracks,function(a){var e=-1,c=!1;h.find(a,function(a){e++;return c=b===a.millisecond});c&&(a=a.splice(e,1)[0])&&delete this._keyframeProperties[a.id]},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};f.Actor.prototype.removeAllKeyframeProperties=function(){h.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};
f.Actor.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,b)};f.Actor.prototype.calculatePosition=function(b){var a=this.getStart(),e=this.getEnd();if(a<=b&&b<=e){var a=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[c(this,b)]],f={};h.each(a,function(a,d){a&&(f[d]=a.getValueAt(b))});this.set(f)}return this};f.Actor.prototype.data=function(b){if(b)this._data=b;return this._data};f.Actor.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),
trackNames:this.getTrackNames(),propertyTracks:{}};h.each(this._propertyTracks,function(a,e){var c=b.propertyTracks[e]=[];h.each(a,function(b){c.push(b.exportPropertyData())})});return b};f.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};h.each(this._keyframeProperties,function(b){this._timelinePropertyCaches[b.millisecond]||(this._timelinePropertyCaches[b.millisecond]={});this._timelinePropertyCaches[b.millisecond][b.name]=b},this);this._timelinePropertyCacheIndex=
h.keys(this._timelinePropertyCaches);h.each(this._timelinePropertyCacheIndex,function(b,a){this._timelinePropertyCacheIndex[a]=+b},this);f.util.sortNumerically(this._timelinePropertyCacheIndex);j(this);o(this)}},B=function(g,a){var c,i=a&&a.underscore?a.underscore:g._,j=a&&a.Tweenable?a.Tweenable:g.Tweenable;c=g.Kapi;c.KeyframeProperty=function(a,c,k,f,g){this.id=i.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=c;this.name=k;this.value=f;this.easing=g||"linear";this.nextProperty=
null;return this};c.KeyframeProperty.prototype.modifyWith=function(a){var c={};i.each(["millisecond","easing","value"],function(g){c[g]="undefined"===typeof a[g]?this[g]:a[g]},this);i.extend(this,c)};c.KeyframeProperty.prototype.linkToNext=function(a){this.nextProperty=a||null};c.KeyframeProperty.prototype.getValueAt=function(a){var c,g,f;c={};g={};this.nextProperty?(c[this.name]=this.value,g[this.name]=this.nextProperty.value,f=this.nextProperty.millisecond-this.millisecond,a=(a-this.millisecond)/
f,c=j.util.interpolate(c,g,a,this.nextProperty.easing)[this.name]):c=this.value;return c};c.KeyframeProperty.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},t=function(g,a){function c(a,c,f){"undefined"!==typeof f&&(a[c]=f,a.style[c]=f+"px");return a[c]}function i(){this.config.clearOnUpdate&&this.canvasClear()}var j=g.Kapi,l=a&&a.underscore?a.underscore:g._;j.prototype._contextInitHook.canvas=function(){this.config.context&&
"CANVAS"===this.config.context.nodeName&&(l.each(["Height","Width"],function(a){var c=a.toLowerCase();this.config[c]&&(this["canvas"+a](this.config[c]),delete this.config[a])},this),this.bind("onBeforeDraw",l.bind(i,this)))};j.prototype.canvasHeight=function(a){return c(this.context,"height",a)};j.prototype.canvasWidth=function(a){return c(this.context,"width",a)};j.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};j.prototype.canvasContext=
function(){return this.context.getContext("2d")}},u=function(g){function a(){}var c=g.Kapi;a.prototype=c.Actor.prototype;c.CanvasActor=function(a){c.Actor.call(this,a);return this};c.CanvasActor.prototype=new a;c.CanvasActor.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},v=function(g,a){function c(){}var i=g.Kapi,j=a&&a.underscore?a.underscore:g._,l=["transform","webkitTransform","MozTransform","oTransform","msTransform"];i.DOMActor=function(a){i.Actor.call(this);
this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=a);delete this.render;return this};c.prototype=i.Actor.prototype;i.DOMActor.prototype=new c;c.prototype.render=function(a,c){j.each(c,function(c,g){"transform"===g?j.each(l,function(g){a.style[g]=c},this):a.style[g]=c},this)};c.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(g,a,c){function i(a){var b=["{"],c;f.each(a.get(),function(a,f){c=a;var h=f;"transform"===f&&(h=o);b.push(h+":"+
c+";")});b.push("}");return b.join("")}function j(a,b,c){var c=c||["w3"],e=[];f.each(c,function(c){c=h(p,[k[c],b,a]).replace(RegExp(o,"g"),k[c]+"transform");e.push(c)});return e.join("\n")}function l(a,b){var b=b||["w3"],c=[],e;f.each(b,function(b){var f=[],b=k[b],d=a.getStart(),g=a.getEnd()-d,g=h("  %sanimation-duration: %sms;",[b,g]);f.push(g);g=h("  %sanimation-name: %s;",[b,a.getCSSName()+"-keyframes"]);f.push(g);d=h("  %sanimation-delay: %sms;",[b,d]);f.push(d);b=h("  %sanimation-fill-mode: forwards;",
[b]);f.push(b);e=f.join("\n");c.push(e)});return h(m,[a.getCSSName(),c.join("\n")])}var o="TRANSFORM",k=g.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},f=c&&c.underscore?c.underscore:a._,p="@%skeyframes %s-keyframes {\n%s\n}",m=".%s {\n  position: absolute;\n%s\n}";a.Kapi.prototype.toCSS=function(a){var a=a||{},b=[],c=this.getActorIds();f.each(c,function(c){b.push(this.getActor(c).toCSS(a))},this);return b.join("\n")};a.Kapi.Actor.prototype.toCSS=function(a){var a=
a||{},b=[],c=a.granularity||100,e=l(this,a.vendors);b.push(e);var e=this.getLength(),f=this.getStart(),g=[],d,c=e/c,h=e/100,k=f+c,m=e+f-c;this.calculatePosition(f);for(g.push("  from "+i(this));k<=m;k+=c)this.calculatePosition(k),d=(k-f)/h,d=+d.toFixed(2),d+="% ",g.push("  "+d+i(this));this.calculatePosition(e+f);g.push("  to "+i(this));e=g.join("\n");a=j(e,this.getCSSName(),a.vendors);b.push(a);return b.join("\n")};var h=g.util.printf=function(a,b){var c=a;f.each(b,function(a){c=c.replace("%s",a)});
return c}},x=function(g,a){var c=a?{}:g;z(c,a,g);A(c,a);B(c,a);"function"===typeof v&&v(c,a);"function"===typeof w&&w(c.Kapi,c,a);"function"===typeof t&&t(c,a);"function"===typeof u&&u(c,a);return c.Kapi};if("function"===typeof define&&define.amd){var C="undefined"!==typeof _;define(["shifty","underscore"],function(g,a){var c={Tweenable:g,underscore:null!==a?a:_},i=x(r,c);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)i.underscore_version=c.underscore.VERSION;if(!C)r._=void 0;return i})}else x("undefined"!==
typeof r?r:this)})(this);
