/*jslint browser: true, nomen: true, plusplus: true, undef: true, sloppy: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.8.16
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var y=function(g,a,d){function k(b,c){return Math.floor(c/b._animationLength)}function i(b){return c()-b._loopTimestamp}function l(b,c){return c>=b._timesToIterate&&-1!==b._timesToIterate}function j(b,c){l(b,c)&&(b.stop(),m(b,"animationComplete"))}function q(b,c,f){return l(b,f)?b._animationLength:c%b._animationLength}function n(b){var c=i(b),f=k(b,c),c=q(b,c,f);b.render(c);j(b,f)}function o(b){var c=function(){o(b);n(b)};b._loopId=b._scheduleUpdate.call?b._scheduleUpdate.call(d,c,1E3/
b.config.fps):setTimeout(c,1E3/b.config.fps)}function m(b,c){e.each(b._events[c],function(c){c(b)})}function h(b){return 60!==b?d.setTimeout:d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame||d.mozCancelRequestAnimationFrame&&d.mozRequestAnimationFrame||d.setTimeout}function s(b){return 60!==b?d.clearTimeout:d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame||d.mozCancelRequestAnimationFrame||
d.clearTimeout}function p(b){b._cancelUpdate.call?b._cancelUpdate.call(d,b._loopId):clearTimeout(b._loopId)}var e=a&&a.underscore?a.underscore:g._,c=(a&&a.Tweenable?a.Tweenable:g.Tweenable).util.now,f={fps:60},a=g.Kapi||function(b){this.config=b||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={frameRender:[],animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeDraw:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;e.extend(this.config,b);e.defaults(this.config,f);this._scheduleUpdate=h(this.config.fps);this._cancelUpdate=s(this.config.fps);e.each(this._contextInitHook,function(b){b.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var b=[];e.each(this._actors,function(c){b.push(c.getEnd())});this._animationLength=Math.max.apply(Math,
b);return this};a.prototype.addActor=function(b){if(!e.contains(this._actors,b))b.context()||b.context(this.context),b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};a.prototype.getActor=function(b){return this._actors[b]};a.prototype.getActorIds=function(){return e.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return e.clone(this._actors)};a.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=
e.without(this._drawOrder,b.id);b.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(b){p(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(c()-this._pausedAtTime):c();this._timesToIterate=b||-1;this._playState="playing";o(this);e.each(this._actors,function(b){b._state.isPaused&&b.resume()});m(this,"playStateChange");m(this,"play");return this};a.prototype.playFrom=function(b,f){this.play(f);this._loopTimestamp=c()-b;return this};a.prototype.playFromCurrent=
function(b){return this.playFrom(this._lastRenderedMillisecond,b)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";p(this);this._pausedAtTime=c();e.each(this._actors,function(b){b._state.isTweening&&b.pause()});m(this,"playStateChange");m(this,"pause");return this};a.prototype.stop=function(){this._playState="stopped";p(this);e.each(this._actors,function(b){b.stop()});m(this,"playStateChange");m(this,"stop");return this};a.prototype.isPlaying=function(){return"playing"===
this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(b){if(b)this.config.fps=b,this._scheduleUpdate=h(this.config.fps),this._cancelUpdate=s(this.config.fps);return this.config.fps};a.prototype.render=function(b){this.calculateActorPositions(b);m(this,"beforeDraw");var c=
this._drawOrder.length,f;this._drawOrderSorter?(f=e.sortBy(this._actors,this._drawOrderSorter),f=e.pluck(f,"id")):f=this._drawOrder;var a,d,j;for(j=0;j<c;j++)a=this._actors[f[j]],d=a.context(),a.render(d,a.get());this._lastRenderedMillisecond=b;m(this,"frameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(b){var c=this._drawOrder.length,f;for(f=0;f<c;f++)this._actors[this._drawOrder[f]].calculatePosition(b);
return this};a.prototype.moveActorToLayer=function(b,c){if(c<this._drawOrder.length)return this._drawOrder=e.without(this._drawOrder,b.id),this._drawOrder.splice(c,0,b.id),b};a.prototype.bind=function(b,c){if(this._events[b])return this._events[b].push(c),this};a.prototype.unbind=function(b,c){if(this._events[b])return this._events[b]=c?e.without(this._events[b],c):[],this};a.prototype.setOrderFunction=function(b){this._drawOrderSorter=b;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=
null;return this};a.prototype.exportTimeline=function(){var b={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};e.each(this._drawOrder,function(c){b.actors[c]=this._actors[c].exportTimeline()},this);return b};a.util={};e.extend(a.util,{noop:function(){},calculateLoopPosition:q,calculateTimeSinceStart:i});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={calculateLoopPosition:q,renderCurrentMillisecond:n,tick:o,determineCurrentLoopIteration:k,calculateTimeSinceStart:i,
isAnimationComplete:l,updatePlayState:j};g.Kapi=a},z=function(g,a){function d(c){return c.sort(function(c,b){return c-b})}function k(c,f){var b=c._timelinePropertyCacheIndex,a=b.length,e;for(e=1;e<a;e++)if(b[e]>=f)return e-1;return-1}function i(c){h.each(c._propertyTracks,function(f,b){c._propertyTracks[b]=h.sortBy(c._propertyTracks[b],function(b){return b.millisecond})})}function l(c){h.each(c._timelinePropertyCaches,function(f,b){var a=j(c,+b);h.defaults(f,a)})}function j(c,f){var b={};h.each(c._propertyTracks,
function(c,a){var e=null;h.find(c,function(c){c.millisecond>f?b[a]=e:c.millisecond===f&&(b[a]=c);e=c;return!!b[a]});if(!b[a]){var d=h.last(c);d&&d.millisecond<=f&&(b[a]=d)}});return b}function q(c){h.each(c._propertyTracks,function(c){h.each(c,function(b,a){b.linkToNext(c[a+1])})})}function n(c,f,b){return h.find(c._propertyTracks[f],function(c){return c.millisecond===b})}function o(c){c._timelinePropertyCaches={};h.each(c._keyframeProperties,function(f){c._timelinePropertyCaches[f.millisecond]||
(c._timelinePropertyCaches[f.millisecond]={});c._timelinePropertyCaches[f.millisecond][f.name]=f},c);c._timelinePropertyCacheIndex=h.keys(c._timelinePropertyCaches);h.each(c._timelinePropertyCacheIndex,function(f,b){c._timelinePropertyCacheIndex[b]=+f},c);d(c._timelinePropertyCacheIndex);l(c);q(c)}var m=0,h=a&&a.underscore?a.underscore:g._,s=a&&a.Tweenable?a.Tweenable:g.Tweenable,p=g.Kapi,e=p.Actor=function(c){c=c||{};this.constructor.call(this);h.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},
_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:m++,setup:c.setup||p.util.noop,render:c.render||p.util.noop,teardown:c.teardown||p.util.noop});c.context&&this.context(opt_context);return this};ActorMethods=function(){};ActorMethods.prototype=s.prototype;e.prototype=new ActorMethods;e.prototype.context=function(c){if(c)this._context=c;return this._context};e.prototype.keyframe=function(c,f,b){var a,b=b||"linear";"string"===typeof b&&(a=b,b={},h.each(f,function(c,f){b[f]=a}));h.each(f,function(c,
f){b[f]=b[f]||"linear"});h.each(f,function(f,a){var e=new p.KeyframeProperty(this,c,a,f,b[a]);this._keyframeProperties[e.id]=e;this._propertyTracks[a]||(this._propertyTracks[a]=[]);this._propertyTracks[a].push(e);i(this)},this);this.kapi._recalculateAnimationLength();o(this);return this};e.prototype.getKeyframeProperty=function(c,f){if(this._propertyTracks[c]&&this._propertyTracks[c][f])return this._propertyTracks[c][f]};e.prototype.modifyKeyframeProperty=function(c,f,b){this._propertyTracks[c]&&
this._propertyTracks[c][f]&&this._propertyTracks[c][f].modifyWith(b);i(this);o(this);return this};e.prototype.getTrackNames=function(){return h.keys(this._propertyTracks)};e.prototype.getTrackLength=function(c){return!this._propertyTracks[c]?void 0:this._propertyTracks[c].length};e.prototype.copyProperties=function(c,f){var b={},a={};h.each(this._propertyTracks,function(c,e){var d=n(this,e,f);if(d)b[e]=d.value,a[e]=d.easing},this);this.keyframe(c,b,a);return this};e.prototype.wait=function(c){var a=
this.getEnd();if(c<=a)return this;var a=this.getEnd(),b=j(this,this.getEnd()),e={},d={};h.each(b,function(b,c){e[c]=b.value;d[c]=b.easing});this.removeKeyframe(a);this.keyframe(a,e,d);this.keyframe(c,e,d);return this};e.prototype.getStart=function(){var c=[];h.each(this._propertyTracks,function(a){a.length&&c.push(a[0].millisecond)});0===c.length&&(c=[0]);return Math.min.apply(Math,c)};e.prototype.getEnd=function(){var c=0;h.each(this._propertyTracks,function(a){if(a.length)a=h.last(a).millisecond,
a>c&&(c=a)},this);return c};e.prototype.getLength=function(){return this.getEnd()-this.getStart()};e.prototype.modifyKeyframe=function(c,a,b){b=b||{};h.each(this._propertyTracks,function(e,d){var j=n(this,d,c);j&&j.modifyWith({value:a[d],easing:b[d]})},this);return this};e.prototype.removeKeyframe=function(c){h.each(this._propertyTracks,function(a){var b=-1,e=!1;h.find(a,function(a){b++;return e=c===a.millisecond});e&&(a=a.splice(b,1)[0])&&delete this._keyframeProperties[a.id]},this);this.kapi._recalculateAnimationLength();
o(this);return this};e.prototype.removeAllKeyframeProperties=function(){h.each(this._propertyTracks,function(c){c.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};e.prototype.moveToLayer=function(c){return this.kapi.moveActorToLayer(this,c)};e.prototype.calculatePosition=function(c){var a=this.getStart(),b=this.getEnd();if(a<=c&&c<=b){var a=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[k(this,c)]],e={};h.each(a,function(b,a){b&&(e[a]=b.getValueAt(c))});this.set(e)}return this};
e.prototype.data=function(c){if(c)this._data=c;return this._data};e.prototype.exportTimeline=function(){var c={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};h.each(this._propertyTracks,function(a,b){var e=c.propertyTracks[b]=[];h.each(a,function(b){e.push(b.exportPropertyData())})});return c}},A=function(g,a){var d=a&&a.underscore?a.underscore:g._,k=a&&a.Tweenable?a.Tweenable:g.Tweenable,i=g.Kapi.KeyframeProperty=function(a,j,g,k,i){this.id=d.uniqueId("keyframeProperty_");
this.ownerActor=a;this.millisecond=j;this.name=g;this.value=k;this.easing=i||"linear";this.nextProperty=null;return this};i.prototype.modifyWith=function(a){var j={};d.each(["millisecond","easing","value"],function(d){j[d]="undefined"===typeof a[d]?this[d]:a[d]},this);d.extend(this,j)};i.prototype.linkToNext=function(a){this.nextProperty=a||null};i.prototype.getValueAt=function(a){var d={},g={};this.nextProperty?(d[this.name]=this.value,g[this.name]=this.nextProperty.value,a=k.util.interpolate(d,
g,(a-this.millisecond)/(this.nextProperty.millisecond-this.millisecond),this.nextProperty.easing)[this.name]):a=this.value;return a};i.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},t=function(g,a){function d(a,d,g){"undefined"!==typeof g&&(a[d]=g,a.style[d]=g+"px");return a[d]}function k(){this.config.clearOnUpdate&&this.canvasClear()}var i=g.Kapi,l=a&&a.underscore?a.underscore:g._;i.prototype._contextInitHook.canvas=
function(){if(this.config.context&&"CANVAS"===this.config.context.nodeName)this.config.clearOnUpdate=!0,l.each(["Height","Width"],function(a){var d=a.toLowerCase();this.config[d]&&(this["canvas"+a](this.config[d]),delete this.config[a])},this),this.bind("beforeDraw",l.bind(k,this))};i.prototype.canvasHeight=function(a){return d(this.context,"height",a)};i.prototype.canvasWidth=function(a){return d(this.context,"width",a)};i.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),
this.canvasHeight());return this};i.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(g){function a(){}var d=g.Kapi;a.prototype=d.Actor.prototype;g=d.CanvasActor=function(a){d.Actor.call(this,a);return this};g.prototype=new a;g.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},v=function(g,a){function d(){}var k=g.Kapi,i=a&&a.underscore?a.underscore:g._,l=["transform","webkitTransform","MozTransform","oTransform",
"msTransform"];k.DOMActor=function(a){k.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=" "+a);delete this.render;delete this.teardown;return this};d.prototype=k.Actor.prototype;k.DOMActor.prototype=new d;d.prototype.render=function(a,d){i.each(d,function(d,g){"transform"===g?i.each(l,function(g){a.style[g]=d},this):a.style[g]=d},this)};d.prototype.teardown=function(){var a=this._context.className.match(/\S+/g);this._context.className=
i.without(a,this.getCSSName())};d.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(g,a){function d(a){var d=["{"],e;j.each(a.get(),function(a,f){e=a;var b=f;"transform"===f&&(b=q);d.push(b+":"+e+";")});d.push("}");return d.join("")}function k(a,d,e){var e=e||["w3"],c=[];j.each(e,function(e){e=h(o,[n[e],d,a]).replace(RegExp(q,"g"),n[e]+"transform");c.push(e)});return c.join("\n")}function i(a,d){var d=d||["w3"],e=[],c;j.each(d,function(d){var b=[],d=n[d],g=a.getStart(),i=a.getEnd()-
g,i=h("  %sanimation-duration: %sms;",[d,i]);b.push(i);i=h("  %sanimation-name: %s;",[d,a.getCSSName()+"-keyframes"]);b.push(i);g=h("  %sanimation-delay: %sms;",[d,g]);b.push(g);d=h("  %sanimation-fill-mode: forwards;",[d]);b.push(d);c=b.join("\n");e.push(c)});return h(m,[a.getCSSName(),e.join("\n")])}var l=g.Kapi,j=a&&a.underscore?a.underscore:g._,q="TRANSFORM",n=l.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},o="@%skeyframes %s-keyframes {\n%s\n}",m=
".%s {\n  position: absolute;\n%s\n}";g.Kapi.prototype.toCSS=function(a){var a=a||{},d=[],e=this.getActorIds();j.each(e,function(c){d.push(this.getActor(c).toCSS(a))},this);return d.join("\n")};g.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},g=[],e=a.granularity||100,c=i(this,a.vendors);g.push(c);var c=this.getLength(),f=this.getStart(),b=[],h,e=c/e,j=c/100,l=f+e,m=c+f-e;this.calculatePosition(f);for(b.push("  from "+d(this));l<=m;l+=e)this.calculatePosition(l),h=(l-f)/j,h=+h.toFixed(2),h+="% ",
b.push("  "+h+d(this));this.calculatePosition(c+f);b.push("  to "+d(this));c=b.join("\n");a=k(c,this.getCSSName(),a.vendors);g.push(a);return g.join("\n")};var h=l.util.printf=function(a,d){var e=a;j.each(d,function(a){e=e.replace("%s",a)});return e}},x=function(g,a){var d=a?{}:g;y(d,a,g);z(d,a);A(d,a);"function"===typeof v&&v(d,a);"function"===typeof w&&w(d,a);"function"===typeof t&&t(d,a);"function"===typeof u&&u(d,a);return d.Kapi};if("function"===typeof define&&define.amd){var B="undefined"!==
typeof _;define(["shifty","underscore"],function(g,a){var d={Tweenable:g,underscore:null!==a?a:_},k=x(r,d);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)k.underscore_version=d.underscore.VERSION;if(!B)r._=void 0;return k})}else x("undefined"!==typeof r?r:this)})(this);
