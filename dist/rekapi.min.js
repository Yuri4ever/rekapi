/*jslint browser: true, nomen: true, plusplus: true, undef: true, sloppy: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.8.21
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var y=function(d,c,b){function g(f,a){return Math.floor(a/f._animationLength)}function h(f){return e()-f._loopTimestamp}function j(f,a){return a>=f._timesToIterate&&-1!==f._timesToIterate}function k(f,a){j(f,a)&&(f.stop(),i(f,"animationComplete"))}function l(f,a,e){return j(f,e)?f._animationLength:a%f._animationLength}function o(f){var a=h(f),e=g(f,a),a=l(f,a,e);f.render(a);k(f,e)}function m(f){var e=function(){m(f);o(f)};f._loopId=f._scheduleUpdate.call?f._scheduleUpdate.call(a,e,1E3/
f.config.fps):setTimeout(e,1E3/f.config.fps)}function i(f,a){c.each(f._events[a],function(a){a(f)})}function s(f){return 60!==f?a.setTimeout:a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||a.mozCancelRequestAnimationFrame&&a.mozRequestAnimationFrame||a.setTimeout}function n(f){return 60!==f?a.clearTimeout:a.cancelAnimationFrame||a.webkitCancelAnimationFrame||a.oCancelAnimationFrame||a.msCancelAnimationFrame||a.mozCancelRequestAnimationFrame||
a.clearTimeout}function p(f){f._cancelUpdate.call?f._cancelUpdate.call(a,f._loopId):clearTimeout(f._loopId)}var a=Function("return this")(),e=b.util.now,q={fps:60},b=d.Kapi||function(a){this.config=a||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={frameRender:[],animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeDraw:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=
this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;c.extend(this.config,a);c.defaults(this.config,q);this._scheduleUpdate=s(this.config.fps);this._cancelUpdate=n(this.config.fps);c.each(this._contextInitHook,function(a){a.call(this)},this);return this};b.prototype._contextInitHook={};b.prototype._recalculateAnimationLength=function(){var a=[];c.each(this._actors,function(e){a.push(e.getEnd())});this._animationLength=Math.max.apply(Math,a);return this};b.prototype.addActor=function(a){if(!c.contains(this._actors,
a))a.context()||a.context(this.context),a.kapi=this,a.fps=this.framerate(),this._actors[a.id]=a,this._drawOrder.push(a.id),a.setup();return this};b.prototype.getActor=function(a){return this._actors[a]};b.prototype.getActorIds=function(){return c.pluck(this._actors,"id")};b.prototype.getAllActors=function(){return c.clone(this._actors)};b.prototype.removeActor=function(a){delete this._actors[a.id];delete a.kapi;this._drawOrder=c.without(this._drawOrder,a.id);a.teardown();this._recalculateAnimationLength();
return this};b.prototype.play=function(a){p(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(e()-this._pausedAtTime):e();this._timesToIterate=a||-1;this._playState="playing";m(this);c.each(this._actors,function(a){a._state.isPaused&&a.resume()});i(this,"playStateChange");i(this,"play");return this};b.prototype.playFrom=function(a,c){this.play(c);this._loopTimestamp=e()-a;return this};b.prototype.playFromCurrent=function(a){return this.playFrom(this._lastRenderedMillisecond,
a)};b.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";p(this);this._pausedAtTime=e();c.each(this._actors,function(a){a._state.isTweening&&a.pause()});i(this,"playStateChange");i(this,"pause");return this};b.prototype.stop=function(){this._playState="stopped";p(this);c.each(this._actors,function(a){a.stop()});i(this,"playStateChange");i(this,"stop");return this};b.prototype.isPlaying=function(){return"playing"===this._playState};b.prototype.animationLength=
function(){return this._animationLength};b.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};b.prototype.actorCount=function(){return this._drawOrder.length};b.prototype.framerate=function(a){if(a)this.config.fps=a,this._scheduleUpdate=s(this.config.fps),this._cancelUpdate=n(this.config.fps);return this.config.fps};b.prototype.render=function(a){this.calculateActorPositions(a);i(this,"beforeDraw");var e=this._drawOrder.length,b;this._drawOrderSorter?
(b=c.sortBy(this._actors,this._drawOrderSorter),b=c.pluck(b,"id")):b=this._drawOrder;var q,d,g;for(g=0;g<e;g++)q=this._actors[b[g]],d=q.context(),q.render(d,q.get());this._lastRenderedMillisecond=a;i(this,"frameRender");return this};b.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};b.prototype.calculateActorPositions=function(a){var e=this._drawOrder.length,c;for(c=0;c<e;c++)this._actors[this._drawOrder[c]].calculatePosition(a);return this};b.prototype.moveActorToLayer=
function(a,e){if(e<this._drawOrder.length)return this._drawOrder=c.without(this._drawOrder,a.id),this._drawOrder.splice(e,0,a.id),a};b.prototype.on=function(a,e){if(this._events[a])return this._events[a].push(e),this};b.prototype.off=function(a,e){if(this._events[a])return this._events[a]=e?c.without(this._events[a],e):[],this};b.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};b.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};b.prototype.exportTimeline=
function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};c.each(this._drawOrder,function(e){a.actors[e]=this._actors[e].exportTimeline()},this);return a};b.util={};c.extend(b.util,{noop:function(){},calculateLoopPosition:l,calculateTimeSinceStart:h});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)b._private={calculateLoopPosition:l,renderCurrentMillisecond:o,tick:m,determineCurrentLoopIteration:g,calculateTimeSinceStart:h,isAnimationComplete:j,updatePlayState:k};
d.Kapi=b},z=function(d,c,b){function g(a){return a.sort(function(a,c){return a-c})}function h(a,e){var c=a._timelinePropertyCacheIndex,f=c.length,b;for(b=1;b<f;b++)if(c[b]>=e)return b-1;return-1}function j(a){c.each(a._propertyTracks,function(e,b){a._propertyTracks[b]=c.sortBy(a._propertyTracks[b],function(a){return a.millisecond})})}function k(a){c.each(a._timelinePropertyCaches,function(e,b){var f=l(a,+b);c.defaults(e,f)})}function l(a,e){var b={};c.each(a._propertyTracks,function(a,d){var g=null;
c.find(a,function(a){a.millisecond>e?b[d]=g:a.millisecond===e&&(b[d]=a);g=a;return!!b[d]});if(!b[d]){var j=c.last(a);j&&j.millisecond<=e&&(b[d]=j)}});return b}function o(a){c.each(a._propertyTracks,function(a){c.each(a,function(c,b){c.linkToNext(a[b+1])})})}function m(a,e,b){return c.find(a._propertyTracks[e],function(a){return a.millisecond===b})}function i(a){a._timelinePropertyCaches={};c.each(a._keyframeProperties,function(e){a._timelinePropertyCaches[e.millisecond]||(a._timelinePropertyCaches[e.millisecond]=
{});a._timelinePropertyCaches[e.millisecond][e.name]=e},a);a._timelinePropertyCacheIndex=c.keys(a._timelinePropertyCaches);c.each(a._timelinePropertyCacheIndex,function(e,b){a._timelinePropertyCacheIndex[b]=+e},a);g(a._timelinePropertyCacheIndex);k(a);o(a)}var s=0,n=d.Kapi,d=n.Actor=function(a){a=a||{};this.constructor.call(this);c.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:s++,setup:a.setup||n.util.noop,render:a.render||
n.util.noop,teardown:a.teardown||n.util.noop});a.context&&this.context(opt_context);return this},p=function(){};p.prototype=b.prototype;d.prototype=new p;d.prototype.context=function(a){if(a)this._context=a;return this._context};d.prototype.keyframe=function(a,e,b){var f,b=b||"linear";"string"===typeof b&&(f=b,b={},c.each(e,function(a,e){b[e]=f}));c.each(e,function(a,e){b[e]=b[e]||"linear"});c.each(e,function(e,c){var f=new n.KeyframeProperty(this,a,c,e,b[c]);this._keyframeProperties[f.id]=f;this._propertyTracks[c]||
(this._propertyTracks[c]=[]);this._propertyTracks[c].push(f);j(this)},this);this.kapi._recalculateAnimationLength();i(this);return this};d.prototype.getKeyframeProperty=function(a,e){if(this._propertyTracks[a]&&this._propertyTracks[a][e])return this._propertyTracks[a][e]};d.prototype.modifyKeyframeProperty=function(a,e,b){this._propertyTracks[a]&&this._propertyTracks[a][e]&&this._propertyTracks[a][e].modifyWith(b);j(this);i(this);return this};d.prototype.getTrackNames=function(){return c.keys(this._propertyTracks)};
d.prototype.getTrackLength=function(a){return!this._propertyTracks[a]?void 0:this._propertyTracks[a].length};d.prototype.copyProperties=function(a,e){var b={},f={};c.each(this._propertyTracks,function(a,c){var d=m(this,c,e);if(d)b[c]=d.value,f[c]=d.easing},this);this.keyframe(a,b,f);return this};d.prototype.wait=function(a){var e=this.getEnd();if(a<=e)return this;var e=this.getEnd(),b=l(this,this.getEnd()),f={},d={};c.each(b,function(a,e){f[e]=a.value;d[e]=a.easing});this.removeKeyframe(e);this.keyframe(e,
f,d);this.keyframe(a,f,d);return this};d.prototype.getStart=function(){var a=[];c.each(this._propertyTracks,function(e){e.length&&a.push(e[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};d.prototype.getEnd=function(){var a=0;c.each(this._propertyTracks,function(e){if(e.length)e=c.last(e).millisecond,e>a&&(a=e)},this);return a};d.prototype.getLength=function(){return this.getEnd()-this.getStart()};d.prototype.modifyKeyframe=function(a,e,b){b=b||{};c.each(this._propertyTracks,
function(c,d){var g=m(this,d,a);g&&g.modifyWith({value:e[d],easing:b[d]})},this);return this};d.prototype.removeKeyframe=function(a){c.each(this._propertyTracks,function(e){var b=-1,f=!1;c.find(e,function(e){b++;return f=a===e.millisecond});f&&(e=e.splice(b,1)[0])&&delete this._keyframeProperties[e.id]},this);this.kapi._recalculateAnimationLength();i(this);return this};d.prototype.removeAllKeyframeProperties=function(){c.each(this._propertyTracks,function(a){a.length=0},this);this._keyframeProperties=
{};return this.removeKeyframe(0)};d.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};d.prototype.calculatePosition=function(a){var e=this.getStart(),b=this.getEnd();if(e<=a&&a<=b){var e=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[h(this,a)]],f={};c.each(e,function(b,e){b&&(f[e]=b.getValueAt(a))});this.set(f)}return this};d.prototype.data=function(a){if(a)this._data=a;return this._data};d.prototype.exportTimeline=function(){var a={start:this.getStart(),
end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};c.each(this._propertyTracks,function(b,d){var f=a.propertyTracks[d]=[];c.each(b,function(a){f.push(a.exportPropertyData())})});return a}},A=function(d,c,b){d=d.Kapi.KeyframeProperty=function(b,d,j,k,l){this.id=c.uniqueId("keyframeProperty_");this.ownerActor=b;this.millisecond=d;this.name=j;this.value=k;this.easing=l||"linear";this.nextProperty=null;return this};d.prototype.modifyWith=function(b){var d={};c.each(["millisecond","easing",
"value"],function(c){d[c]="undefined"===typeof b[c]?this[c]:b[c]},this);c.extend(this,d)};d.prototype.linkToNext=function(b){this.nextProperty=b||null};d.prototype.getValueAt=function(c){var d={},j={};this.nextProperty?(d[this.name]=this.value,j[this.name]=this.nextProperty.value,c=b.util.interpolate(d,j,(c-this.millisecond)/(this.nextProperty.millisecond-this.millisecond),this.nextProperty.easing)[this.name]):c=this.value;return c};d.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,
name:this.name,value:this.value,easing:this.easing}}},t=function(d,c){function b(b,c,d){"undefined"!==typeof d&&(b[c]=d,b.style[c]=d+"px");return b[c]}function g(){this.config.clearOnUpdate&&this.canvasClear()}var h=d.Kapi;h.prototype._contextInitHook.canvas=function(){if(this.config.context&&"CANVAS"===this.config.context.nodeName)this.config.clearOnUpdate=!0,c.each(["Height","Width"],function(b){var c=b.toLowerCase();this.config[c]&&(this["canvas"+b](this.config[c]),delete this.config[b])},this),
this.on("beforeDraw",c.bind(g,this))};h.prototype.canvasHeight=function(c){return b(this.context,"height",c)};h.prototype.canvasWidth=function(c){return b(this.context,"width",c)};h.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};h.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(d){function c(){}var b=d.Kapi;c.prototype=b.Actor.prototype;d=b.CanvasActor=function(c){b.Actor.call(this,c);return this};
d.prototype=new c;d.prototype.context=function(b){if(b)this._context=b;return this._context&&this._context.getContext("2d")}},v=function(d,c){function b(){}var g=d.Kapi,h=["transform","webkitTransform","MozTransform","oTransform","msTransform"];g.DOMActor=function(b){g.Actor.call(this);this._context=b;b=this.getCSSName();this._context.className.match(b)||(this._context.className+=" "+b);delete this.render;delete this.teardown;return this};b.prototype=g.Actor.prototype;g.DOMActor.prototype=new b;b.prototype.render=
function(b,d){c.each(d,function(d,g){"transform"===g?c.each(h,function(c){b.style[c]=d},this):b.style[g]=d},this)};b.prototype.teardown=function(){var b=this._context.className.match(/\S+/g);this._context.className=c.without(b,this.getCSSName())};b.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(d,c){function b(b){var d=["{"],g;c.each(b.get(),function(a,b){g=a;var c=b;"transform"===b&&(c=k);d.push(c+":"+g+";")});d.push("}");return d.join("")}function g(b,d,g){var g=g||["w3"],a=
[];c.each(g,function(c){c=i(o,[l[c],d,b]).replace(RegExp(k,"g"),l[c]+"transform");a.push(c)});return a.join("\n")}function h(b,d){var d=d||["w3"],g=[],a;c.each(d,function(c){var d=[],c=l[c],f=b.getStart(),h=b.getEnd()-f,h=i("  %sanimation-duration: %sms;",[c,h]);d.push(h);h=i("  %sanimation-name: %s;",[c,b.getCSSName()+"-keyframes"]);d.push(h);f=i("  %sanimation-delay: %sms;",[c,f]);d.push(f);c=i("  %sanimation-fill-mode: forwards;",[c]);d.push(c);a=d.join("\n");g.push(a)});return i(m,[b.getCSSName(),
g.join("\n")])}var j=d.Kapi,k="TRANSFORM",l=j.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},o="@%skeyframes %s-keyframes {\n%s\n}",m=".%s {\n  position: absolute;\n%s\n}";d.Kapi.prototype.toCSS=function(b){var b=b||{},d=[],g=this.getActorIds();c.each(g,function(a){d.push(this.getActor(a).toCSS(b))},this);return d.join("\n")};d.Kapi.Actor.prototype.toCSS=function(c){var c=c||{},d=[],i=c.granularity||100,a=h(this,c.vendors);d.push(a);var a=this.getLength(),
e=this.getStart(),j=[],f,i=a/i,l=a/100,k=e+i,m=a+e-i;this.calculatePosition(e);for(j.push("  from "+b(this));k<=m;k+=i)this.calculatePosition(k),f=(k-e)/l,f=+f.toFixed(2),f+="% ",j.push("  "+f+b(this));this.calculatePosition(a+e);j.push("  to "+b(this));a=j.join("\n");c=g(a,this.getCSSName(),c.vendors);d.push(c);return d.join("\n")};var i=j.util.printf=function(b,d){var g=b;c.each(d,function(a){g=g.replace("%s",a)});return g}},x=function(d,c){var b=c?{}:d,g=c&&c.underscore?c.underscore:b._,h=c&&c.Tweenable?
c.Tweenable:b.Tweenable;y(b,g,h);z(b,g,h);A(b,g,h);"function"===typeof v&&v(b,g,h);"function"===typeof w&&w(b,g,h);"function"===typeof t&&t(b,g,h);"function"===typeof u&&u(b,g,h);return b.Kapi};if("function"===typeof define&&define.amd){var B="undefined"!==typeof _;define(["shifty","underscore"],function(d,c){var b={Tweenable:d,underscore:null!==c?c:_},g=x(r,b);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)g.underscore_version=b.underscore.VERSION;if(!B)r._=void 0;return g})}else x("undefined"!==
typeof r?r:this)})(this);
